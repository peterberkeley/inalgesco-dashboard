#include <WiFi.h>
#include <WiFiClientSecure.h>
#include "AdafruitIO_WiFi.h"
#include <Wire.h>
#include <RTClib.h>
#include <ArduinoJson.h>

// Replace with your Wi-Fi and Adafruit IO credentials
#define IO_USERNAME  "Inalgescotest"
#define IO_KEY       "your_aio_key_here"
#define WIFI_SSID    "Four Winds"
#define WIFI_PASS    "deirdre68"

// Set up Adafruit IO
AdafruitIO_WiFi io(IO_USERNAME, IO_KEY, WIFI_SSID, WIFI_PASS);
AdafruitIO_Feed *gpsFeed = io.feed("yellowboard.gps");

// RTC object
RTC_DS3231 rtc;

// Simulated sensors (replace with real sensor readings)
float getNR1() { return 23.5; }  // replace with real sensor code
float getNR2() { return 24.7; }
float getNR3() { return 22.9; }
float getLatitude() { return 51.5074; } // replace with GPS parsing
float getLongitude() { return -0.1278; }
int getSatCount() { return 7; }  // e.g., from GPS library
bool hasFix() { return true; }

void setup() {
  Serial.begin(115200);
  while (!Serial);

  // Connect to Adafruit IO
  Serial.print("Connecting to Adafruit IO");
  io.connect();
  while (io.status() < AIO_CONNECTED) {
    Serial.print(".");
    delay(500);
  }
  Serial.println(" connected!");

  // Initialize RTC
  if (!rtc.begin()) {
    Serial.println("Couldn't find RTC. Halting.");
    while (true);
  }

  if (rtc.lostPower()) {
    Serial.println("RTC lost power, setting to compile time.");
    rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));
  }
}

void loop() {
  io.run();

  DateTime now = rtc.now();

  // ISO 8601 timestamp in UTC
  char isoTimestamp[25];
  snprintf(isoTimestamp, sizeof(isoTimestamp), "%04d-%02d-%02dT%02d:%02d:%02dZ",
           now.year(), now.month(), now.day(),
           now.hour(), now.minute(), now.second());

  // Construct JSON
  StaticJsonDocument<256> doc;
  doc["ts"] = isoTimestamp;
  doc["fix"] = hasFix();
  doc["lat"] = getLatitude();
  doc["lon"] = getLongitude();
  doc["sats"] = getSatCount();
  doc["nr1"] = getNR1();
  doc["nr2"] = getNR2();
  doc["nr3"] = getNR3();

  // Serialize to string
  char payload[300];
  serializeJson(doc, payload, sizeof(payload));

  // Send to Adafruit IO
  Serial.print("Sending: ");
  Serial.println(payload);
  gpsFeed->save(payload);

  delay(10000); // poll every 10 seconds
}
