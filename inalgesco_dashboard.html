<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inalgesco Datalogger Dashboard</title>

  <!-- Brand font → Inter (light, regular, bold) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- Leaflet map library -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    /* -------------  COLOURS  ------------- */
    :root {
      --brand-yellow: #ffd500;
      --brand-dark:   #222;   /* almost‑black for text */
      --brand-grey:   #626262;
      --card-bg:      #ffffff;
      --bg:           #f5f5f5;
    }

    /* -------------  BASE  ------------- */
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--brand-dark);
      font-family:'Inter',system-ui,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    /* -------------  HEADER  ------------- */
    header{
      background:linear-gradient(90deg,var(--brand-yellow) 0%,#ffbd00 100%);
      padding:0.75rem 1rem;
      display:flex;
      align-items:center;
      gap:0.75rem;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    header img{
      height:40px;
      width:auto;
    }
    header h1{
      margin:0;
      font-size:1.35rem;
      font-weight:600;
      letter-spacing:0.01em;
    }

    /* -------------  LAYOUT  ------------- */
    .flex{ display:flex; flex-wrap:wrap; gap:1rem; padding:1rem; }

    .card{
      background:var(--card-bg);
      border-radius:0.75rem;
      padding:1rem;
      flex:1 1 350px;
      box-shadow:0 4px 10px rgba(0,0,0,0.08);
      animation:fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn{ from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;} }

    h2{ margin:0 0 0.5rem 0; font-size:1.1rem; font-weight:600; }

    /* -------------  TABLE  ------------- */
    table{ width:100%; border-collapse:collapse; font-size:0.92rem; }
    th,td{ padding:0.45rem 0.35rem; text-align:left; border-bottom:1px solid #eee; }
    th{ background:#fafafa; font-weight:600; }

    /* -------------  MAP  ------------- */
    #map{ height:420px; border-radius:0.75rem; overflow:hidden; }
  </style>
</head>
<body>
  <header>
    <!-- ⚠️  Replace logo.svg with your actual logo file (SVG or PNG) -->
    <img src="logo.svg" alt="Inalgesco logo" onerror="this.style.display='none'" />
    <h1>Inalgesco Datalogger</h1>
  </header>

  <div class="flex">
    <div class="card">
      <h2>Latest Fix</h2>
      <table id="latest"></table>
    </div>
    <div class="card">
      <h2>Last 5 Points</h2>
      <table id="history"></table>
    </div>
  </div>

  <div class="card" style="margin:1rem">
    <h2>Map View</h2>
    <div id="map"></div>
  </div>

  <script>
  /* ---------------------- CONFIG ---------------------- */
  const AIO_USERNAME = "Inalgescotest";   // public Adafruit IO username
  const FEED_KEY     = "yellowboard.gps"; // feed slug (must be public)
  const LIMIT        = 5;                  // how many points to fetch
  const POLL_MS      = 10_000;             // poll interval in ms
  /* ---------------------------------------------------- */

  let map, marker, polyline;

  async function fetchFeed(limit=1){
    const url=`https://io.adafruit.com/api/v2/${AIO_USERNAME}/feeds/${FEED_KEY}/data?limit=${limit}`;
    const res=await fetch(url);
    if(!res.ok) throw new Error(await res.text());
    return res.json();
  }

  function renderLatest(obj){
    const lat=Number.parseFloat(obj.lat).toFixed(6);
    const lon=Number.parseFloat(obj.lon).toFixed(6);
    const rows=Object.entries(obj).map(([k,v])=>`<tr><th>${k}</th><td>${v}</td></tr>`);
    document.getElementById("latest").innerHTML=rows.join("");

    if(!map){
      map=L.map('map').setView([lat,lon],13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap' }).addTo(map);
      marker=L.marker([lat,lon]).addTo(map);
      polyline=L.polyline([], {weight:3}).addTo(map);
    }else{
      marker.setLatLng([lat,lon]);
    }
  }

  function renderHistory(arr){
    const header=`<tr><th>ts</th><th>lat</th><th>lon</th><th>sats</th></tr>`;
    const rows=arr.map(o=>`<tr><td>${o.ts}</td><td>${o.lat}</td><td>${o.lon}</td><td>${o.sats}</td></tr>`);
    document.getElementById("history").innerHTML=header+rows.join("");

    if(polyline){
      polyline.setLatLngs(arr.map(o=>[o.lat,o.lon]));
      map.fitBounds(polyline.getBounds(), {padding:[50,50]});
    }
  }

  async function poll(){
    try{
      const data=await fetchFeed(LIMIT);
      const parsed=data.map(d=>{ try{return JSON.parse(d.value);}catch{ return {raw:d.value}; } });
      if(parsed.length){
        renderLatest(parsed[0]);
        renderHistory(parsed);
      }
    }catch(err){ console.error(err); }
    finally{ setTimeout(poll,POLL_MS); }
  }

  poll();
  </script>
</body>
</html>
