<script>
/* ---------- CONFIG ---------- */
const USER = "Inalgescodatalogger";
const FEEDS = {
  gps:    "gps",
  signal: "signal",
  volt:   "volt",
  speed:  "speed",
  nr1:    "nr1",
  nr2:    "nr2",
  nr3:    "nr3"
};
const LIMIT   = 5;
const POLL_MS = 10000;

/* ---------- helpers ---------- */
const api = (feed,lim=1)=>
  `https://io.adafruit.com/api/v2/${USER}/feeds/${feed}/data?limit=${lim}`;

async function safeFetch(feed, lim = 1) {
  try {
    const r = await fetch(api(feed, lim));
    if (!r.ok) return [];              // 404 or 401 → treat as empty
    return r.json();
  } catch { return []; }
}
const td=x=>`<td>${x}</td>`;
const fmt=(v,p=1)=>v==null?"–":(typeof v==="number"?v.toFixed(p):v);

let map,marker,poly;

/* ---------- render ---------- */
function renderLatest(d){
  const rows=[
    ["local", new Date(d.gps.ts).toLocaleString()],
    ["fix",   d.gps.fix],
    ["lat",   fmt(d.gps.lat,6)],
    ["lon",   fmt(d.gps.lon,6)],
    ["alt m", fmt(d.gps.alt,1)],
    ["sats",  d.gps.sats??"–"],
    ["speed km/h", fmt(d.speed,1)],
    ["RSSI dBm", d.signal],
    ["volt mV", d.volt],
    ["NR1 °C", fmt(d.nr1,1)],
    ["NR2 °C", fmt(d.nr2,1)],
    ["NR3 °C", fmt(d.nr3,1)]
  ].map(r=>`<tr><th>${r[0]}</th>${td(r[1])}</tr>`).join("");
  latest.innerHTML = rows;

  if(d.gps.fix){
    const {lat,lon}=d.gps;
    if(!map){
      map=L.map('map').setView([lat,lon],13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        {attribution:'© OpenStreetMap'}).addTo(map);
      marker=L.marker([lat,lon]).addTo(map);
      poly=L.polyline([], {weight:3}).addTo(map);
    }else marker.setLatLng([lat,lon]);
  }
}

function renderHist(list){
  history.innerHTML =
    "<tr><th>ts</th><th>lat</th><th>lon</th><th>speed</th></tr>" +
    list.map(o=>
      `<tr>${td(o.ts)}${td(fmt(o.lat,4))}${td(fmt(o.lon,4))}${td(fmt(o.speed,1))}</tr>`
    ).join("");

  if(poly){
    const pts=list.filter(o=>o.fix).map(o=>[o.lat,o.lon]);
    poly.setLatLngs(pts);
    if(pts.length) map.fitBounds(poly.getBounds(),{padding:[40,40]});
  }
}

/* ---------- poll loop ---------- */
async function poll(){
  try{
    const results = await Promise.allSettled([
      safeFetch(FEEDS.gps ,LIMIT),
      safeFetch(FEEDS.signal), safeFetch(FEEDS.volt),
      safeFetch(FEEDS.speed),  safeFetch(FEEDS.nr1),
      safeFetch(FEEDS.nr2),    safeFetch(FEEDS.nr3)
    ]);

    const [gps,signal,volt,speed,nr1,nr2,nr3] = results.map(r=>r.value||[]);

    const gpsParsed = gps.map(d=>JSON.parse(d.value));
    if (!gpsParsed.length) throw new Error("No GPS data yet");

    const latest = {
      gps: gpsParsed[0],
      signal: signal[0]?.value ?? "–",
      volt:   volt[0]?.value ?? "–",
      speed:  speed[0]?.value ?? "–",
      nr1:    nr1[0]?.value ?? "–",
      nr2:    nr2[0]?.value ?? "–",
      nr3:    nr3[0]?.value ?? "–"
    };

    renderLatest(latest);
    renderHist(gpsParsed);
  }catch(e){ console.warn(e.message); }
  finally{ setTimeout(poll,POLL_MS); }
}
poll();
</script>
