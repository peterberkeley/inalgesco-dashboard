<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Truck Dropdown Test</title>
</head>
<body>
  <label for="deviceSelect"><b>Select Truck:</b></label>
  <select id="deviceSelect"></select>
  <div id="log" style="white-space:pre; font-family:monospace; margin-top:2em"></div>
  <script>
    const DEVICES = Array.from({length: 24}, (_, i) => `skycafe-${i+1}`);
    const UBIDOTS_TOKEN = "BBUS-Ghwc4x45HcRvzw1eOVF1DfBQBnAP7L";
    const UBIDOTS_BASE = "https://industrial.api.ubidots.com/api/v1.6";

    async function checkLiveness(dev) {
      try {
        const url = `${UBIDOTS_BASE}/variables/?device=${dev}&token=${UBIDOTS_TOKEN}`;
        const res = await fetch(url);
        if (!res.ok) return {status: 'offline', reason: 'HTTP ' + res.status};
        const js = await res.json();
        const now = Date.now();
        for (const v of js.results || []) {
          if (v.last_value && v.last_value.timestamp) {
            const diff = now - v.last_value.timestamp;
            if (diff < 60000) {
              return {status: 'online', label: v.label, diff};
            }
          }
        }
        return {status: 'offline', reason: 'no variable within 60s'};
      } catch (e) {
        return {status: 'offline', reason: e.message};
      }
    }

    async function fillDropdown() {
      const deviceStatus = {};
      const logLines = [];
      for (const dev of DEVICES) {
        const info = await checkLiveness(dev);
        deviceStatus[dev] = info.status;
        logLines.push(
          `${dev}: ${info.status}${info.status === 'online' ? ` (last var=${info.label}, diff=${info.diff}ms)` : ` (${info.reason})`}`
        );
      }
      const sel = document.getElementById('deviceSelect');
      sel.innerHTML = '';
      for (const dev of DEVICES) {
        const opt = document.createElement('option');
        opt.value = dev;
        opt.text = dev.replace('skycafe-','SkyCafÃ© ');
        if (deviceStatus[dev] === 'offline') {
          opt.disabled = true;
          opt.text += ' (Offline)';
        }
        sel.appendChild(opt);
      }
      document.getElementById('log').textContent = logLines.join('\n');
    }

    fillDropdown();
  </script>
</body>
</html>
