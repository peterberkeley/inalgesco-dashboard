<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sky Café Trucks Dashboard</title>

  <!-- Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Styles -->
  <style>
    :root{
      --color-bg:#f6f7fb;
      --color-card:#ffffff;
      --color-text:#0f172a;
      --color-primary:#3b82f6;
    }
    html,body{ height:100% }
    body{
      background:var(--color-bg);
      color:var(--color-text);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
    }

    /* Cards */
    .card{ background:var(--color-card); border-radius:1rem; box-shadow:0 6px 28px rgba(15,23,42,.06) }

    /* KPI tiles */
    .kpi{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:.75rem }
    .kpi .tile{ background:var(--color-card); border-radius:1rem; box-shadow:0 4px 16px rgba(15,23,42,.06); padding:1rem }
    .kpi .lab{ font-size:.72rem; letter-spacing:.02em; text-transform:uppercase; color:#6b7280; }
    .kpi .val{ font-weight:700; font-size:1.35rem; line-height:1.2 }
    .kpi .sub{ font-size:.72rem; color:#6b7280 }

    /* Charts area grid */
    #charts{ display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); gap:1rem }
    .chart-box{ background:var(--color-card); border-radius:1rem; box-shadow:0 4px 16px rgba(15,23,42,.06); padding:1rem 1rem 1.25rem; height:360px; overflow:hidden; }
    .chart-box h3{ font-weight:700; margin:0 0 .5rem 0; font-size:1rem }

    /* Info table */
    #latest{ width:100%; border-radius:.75rem; overflow:hidden; }
    #latest th{ text-align:left; padding:.45rem .6rem; font-weight:600; color:#334155; width:55% }
    #latest td{ text-align:right; padding:.45rem .6rem; color:#0f172a; font-variant-numeric:tabular-nums }
    #latest tr:nth-child(odd){ background:#f9fafb }
    #latest tr:nth-child(even){ background:#f3f4f6 }

    /* Phone-like signal bars */
    .sig{ display:inline-flex; gap:2px; vertical-align:middle }
    .sig i{ width:5px; background:#e5e7eb; border-radius:2px; display:inline-block }
    .sig i.on{ background:#10b981 }
    .sig i.l1{ height:6px } .sig i.l2{ height:9px } .sig i.l3{ height:12px } .sig i.l4{ height:15px } .sig i.l5{ height:18px }
    .sig.low  i.on{ background:#ef4444 }
    .sig.med  i.on{ background:#f59e0b }
    .sig.high i.on{ background:#10b981 }

    /* Map height */
    #map{ height:22rem }
    @media (min-width:1024px){ #map{ height:34rem } }

    /* Spinner */
    #spinner{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; backdrop-filter:saturate(1.2) blur(2px);
      background:rgba(255,255,255,.4); z-index:60;
    }
    #spinner:before{
      content:""; width:42px; height:42px; border-radius:50%;
      border:4px solid rgba(2,6,23,.12); border-top-color:var(--color-primary);
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* Breadcrumb legend styling */
    .breadcrumb-legend { font-size: 0.75rem; }

    /* Tooltip styling for breadcrumbs */
    .leaflet-tooltip.tooltip {
      background:#fff;
      color:#374151;
      border:1px solid #d1d5db;
      border-radius:4px;
      padding:2px 4px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
  <style>
  #auth-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.55); z-index: 9999; }
  #auth-card { background: #111; color: #fff; padding: 24px; border-radius: 12px; width: min(92vw, 360px); box-shadow: 0 10px 30px rgba(0,0,0,0.4); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; }
  #auth-card h2 { margin: 0 0 12px 0; font-size: 18px; }
  #auth-card p  { margin: 0 0 16px 0; font-size: 13px; opacity: .8; }
  #auth-card input[type="password"] { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #333; background: #000; color: #fff; outline: none; }
  #auth-card button { margin-top: 12px; width: 100%; padding: 10px 12px; border-radius: 8px; border: none; cursor: pointer; }
  #auth-error { color: #ff9b9b; font-size: 12px; min-height: 16px; margin-top: 8px; }
</style>
</head>
<body>
  <div id="auth-overlay" aria-modal="true" role="dialog">
  <div id="auth-card">
    <h2>Sky Café Dashboard</h2>
    <p>Please enter the dashboard password to continue.</p>
    <form id="auth-form">
      <input id="auth-pass" type="password" inputmode="text" autocomplete="current-password" placeholder="Password" required />
      <div id="auth-error"></div>
      <button type="submit">Unlock</button>
    </form>
  </div>
</div>


  <!-- Header -->
  <header class="sticky top-0 z-40 backdrop-blur bg-gradient-to-r from-[#d9eaf8]/90 to-[#3b82f6]/90">
    <div class="max-w-7xl mx-auto px-4 py-2 flex items-center gap-3">
      <!-- Full-color transparent PNG logo -->
    <img
  src="logo_high_resolution.png"
  onerror="this.onerror=null; this.src='logo_high_resolution_white.png'"
  alt="Inalgesco"
  class="h-9 w-auto select-none pointer-events-none"
/>

      <div class="flex flex-col leading-tight">
        <span class="text-white font-semibold text-lg">Sky Café Trucks</span>
        <span class="text-white/80 text-xs -mt-0.5">Dashboard</span>
      </div>

      <div class="ml-auto flex items-center gap-2">
        <label class="text-white font-medium text-sm">Device:</label>
        <select id="deviceSelect" class="px-2 py-1 rounded border border-white/30 bg-white/90 text-slate-700"></select>
        <span id="deviceStatusPill" class="hidden px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-700">Online</span>
<button id="adminBtn"    class="px-3 py-1 rounded bg-white/20 text-white hover:bg-white/30 border border-white/30">Admin</button>

      </div>
    </div>
  </header>
  <script>
    // Admin nav
    document.getElementById('adminBtn').onclick=()=>{ window.location.href='admin.html' };
const flightsBtn = document.getElementById('flightsBtn');
if (flightsBtn) {
  flightsBtn.onclick = () => { window.location.href = 'flights_aa_phx.html'; };
}

    // Online/offline pill
    window.__setDeviceStatus = function(isOnline){
      const p=document.getElementById('deviceStatusPill');
      if(!p) return;
      p.classList.remove("hidden");
      if(isOnline){
        p.textContent="Online";
        p.className="px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-700";
      }else{
        p.textContent="Offline";
        p.className="px-2 py-0.5 text-xs font-semibold rounded-full bg-gray-100 text-gray-700";
      }
    };
  </script>

  <!-- Main -->
  <main class="max-w-7xl mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-4 gap-6">

    <!-- Left column -->
    <section class="lg:col-span-1 space-y-4">
      <div class="kpi">
        <div class="tile md:col-span-2">
          <div class="lab">Truck</div>
          <div class="val text-[1.1rem]" id="kpiTruck">—</div>
          <div class="sub" id="kpiSeen">—</div>
        </div>
        <div class="tile">
          <div class="lab">Avg Temp</div>
          <div class="val" id="kpiAvg">—</div>
          <div class="sub">last readings</div>
        </div>
      </div>

      <div class="card p-4">
        <h2 class="text-lg font-semibold mb-2">Current Fix &amp; Sensors</h2>
     <div id="latestWrap" class="max-h-72 overflow-auto pr-1">
  <table id="latest" class="w-full text-sm"></table>
</div>
      <div class="card p-4">
        <h2 class="text-lg font-semibold mb-2">Export Data (CSV)</h2>
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <label class="text-sm text-gray-600">Start</label>
          <input type="date" id="start" class="border p-1 rounded" />
          <label class="text-sm text-gray-600">End</label>
          <input type="date" id="end" class="border p-1 rounded" />
          <button id="dlBtn" class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700">Download</button>
        </div>
        <div id="expStatus" class="text-sm text-gray-600"></div>
      </div>

      <div id="maintenanceBox" class="card p-4">
        <h2 class="text-lg font-semibold mb-2">Maintenance Status</h2>
        <div class="text-sm text-gray-500">Loading…</div>
      </div>
    </section>

    <!-- Right column -->
    <section class="lg:col-span-3 grid grid-cols-1 gap-4">
      <div class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h2 class="text-lg font-semibold">Sensors</h2>
            <div id="chartRange" class="text-sm text-gray-500"></div>
          </div>
          <div class="flex items-center gap-2 text-sm">
            <button data-range="60"  data-mode="range" class="rangeBtn px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">1h</button>
            <button data-range="180" data-mode="range" class="rangeBtn px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">3h</button>
            <button data-range="720" data-mode="range" class="rangeBtn px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">12h</button>
            <button data-range="1440" data-mode="range" class="rangeBtn px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">24h</button>
            <button data-range="60"  data-mode="last"  class="rangeBtn px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">Last</button>
          </div>
        </div>
        <div id="charts"></div>
      </div>

      <div class="card p-4">
        <h2 class="text-lg font-semibold mb-2">Map View</h2>
        <div id="map" class="rounded-lg"></div>
      </div>
    </section>
  </main>

   <div id="spinner"></div>
<script src="dashboard.js?v=fix4" defer></script>
  <script>
window.addEventListener('DOMContentLoaded', () => {
  const PASSWORD = "Skycafe8971";

  const overlay = document.getElementById("auth-overlay");
  const form    = document.getElementById("auth-form");
  const pass    = document.getElementById("auth-pass");
  const err     = document.getElementById("auth-error");

  // If any element is missing, bail gracefully
  if (!overlay || !form || !pass || !err) {
    console.warn("[auth] Overlay elements not found — auth disabled.");
    return;
  }

  function showLock(msg) {
    overlay.style.display = "flex";
    err.textContent = msg ? msg : "";
    pass.value = "";
    pass.focus();
  }
  function hideLock() {
    overlay.style.display = "none";
    // seed activity so admin can see you were recently active
    localStorage.setItem("sc_last_activity", Date.now().toString());
  }

  // Always gate on initial page load
  showLock();

  // Handle submit
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    if (pass.value.trim() === PASSWORD) {
      hideLock();
    } else {
      err.textContent = "Incorrect password";
      pass.select();
    }
  });

  // Track activity for admin idle timer
  ["mousemove","keydown","touchstart","scroll","click"].forEach(evt =>
    document.addEventListener(evt, () =>
      localStorage.setItem("sc_last_activity", Date.now().toString())
    , { passive:true })
  );
});
</script>
</body>
</html>
